var E=class{allowResourceHostOverride;parameterEncoder;authAttr;binary;bodyAttr;headers;headersAttr;host;hostAttr;method;middleware;params;path;pathAttr;queryParamAlias;timeoutAttr;constructor(e){this.allowResourceHostOverride=e.allowResourceHostOverride||!1,this.parameterEncoder=e.parameterEncoder||encodeURIComponent,this.binary=e.binary||!1,this.headers=e.headers,this.host=e.host,this.method=e.method||"get",this.params=e.params,this.path=e.path,this.queryParamAlias=e.queryParamAlias||{},this.authAttr=e.authAttr||"auth",this.bodyAttr=e.bodyAttr||"body",this.headersAttr=e.headersAttr||"headers",this.hostAttr=e.hostAttr||"host",this.pathAttr=e.pathAttr||"path",this.timeoutAttr=e.timeoutAttr||"timeout";let t=e.middleware||e.middlewares||[];this.middleware=t}};var x,q,B;try{x=eval('typeof __TEST_WEB__ === "undefined" && typeof process === "object" ? process : undefined')}catch(o){}var X=()=>typeof x<"u"&&x!==null&&x.hrtime;X()&&(q=()=>{let o=x.hrtime();return o[0]*1e9+o[1]},B=q());var Y=/%20/g,C=o=>o!=null,de=o=>Object.keys(o).filter(e=>C(o[e])),F=(o,e,t="",r=encodeURIComponent)=>Array.isArray(e)?e.map(s=>F(o,s,t+"[]",r)).join("&"):typeof e!="object"?`${r(o+t)}=${r(e)}`:Object.keys(e).map(s=>{let i=e[s];return C(i)?F(o,i,t+"["+s+"]",r):null}).filter(C).join("&"),M=(o,e=encodeURIComponent)=>D(o)?Object.keys(o).map(t=>{let r=o[t];return C(r)?F(t,r,"",e):null}).filter(C).join("&").replace(Y,"+"):o,H=()=>{if(X()&&q!==void 0){let o=q();if(o!==void 0&&B!==void 0)return(o-B)/1e6}return Date.now()},K=o=>{let e={};if(!o)return e;let t=o.split(`\r
`);for(let r=0;r<t.length;r++){let s=t[r],i=s.indexOf(": ");if(i>0){let a=s.substring(0,i).toLowerCase().trim(),c=s.substring(i+2).trim();e[a]=c}}return e},O=o=>Object.keys(o).reduce((e,t)=>(e[t.toLowerCase()]=o[t],e),{}),Z=Object.prototype.hasOwnProperty,h=Object.assign||function(o){for(let e=1;e<arguments.length;e++){let t=arguments[e];for(let r in t)Z.call(t,r)&&(o[r]=t[r])}return o},ee=Object.prototype.toString,D=o=>ee.call(o)==="[object Object]"&&Object.getPrototypeOf(o)===Object.getPrototypeOf({}),pe=o=>typeof o=="object"&&o!==null&&!Array.isArray(o),te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",k=o=>{let e="",t=te,r=String(o);for(let s=0,i,a=0;r.charAt(a|0)||(t="=",a%1);e+=t.charAt(63&s>>8-a%1*8)){if(i=r.charCodeAt(a+=3/4),i>255)throw new Error("[Mappersmith] 'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");s=s<<8|i}return e};var S=class{host;allowResourceHostOverride;parameterEncoder;bodyAttr;headersAttr;authAttr;timeoutAttr;hostAttr;clientId;gatewayConfigs;resources;context;middleware;constructor(e,{gatewayConfigs:t,middleware:r=[],context:s={}}){this.host=e.host,this.allowResourceHostOverride=e.allowResourceHostOverride||!1,this.parameterEncoder=e.parameterEncoder||encodeURIComponent,this.bodyAttr=e.bodyAttr,this.headersAttr=e.headersAttr,this.authAttr=e.authAttr,this.timeoutAttr=e.timeoutAttr,this.hostAttr=e.hostAttr,this.clientId=e.clientId||null,this.gatewayConfigs=h({},t,e.gatewayConfigs),this.resources=e.resources||{},this.context=s;let i=e.middleware||e.middlewares||[];e.ignoreGlobalMiddleware?this.middleware=i:this.middleware=[...i,...r]}eachResource(e){Object.keys(this.resources).forEach(t=>{let r=this.eachMethod(t,s=>({name:s,descriptor:this.createMethodDescriptor(t,s)}));e(t,r)})}eachMethod(e,t){return Object.keys(this.resources[e]).map(t)}createMethodDescriptor(e,t){let r=this.resources[e][t];if(!r||!["string","function"].includes(typeof r.path))throw new Error(`[Mappersmith] path is undefined for resource "${e}" method "${t}"`);return new E(h({host:this.host,allowResourceHostOverride:this.allowResourceHostOverride,parameterEncoder:this.parameterEncoder,bodyAttr:this.bodyAttr,headersAttr:this.headersAttr,authAttr:this.authAttr,timeoutAttr:this.timeoutAttr,hostAttr:this.hostAttr},r))}createMiddleware(e){let t=c=>{let f={__name:c.name||c.toString(),response(p){return p()},prepareRequest(p){return this.request?p().then(m=>{var n;return(n=this.request)==null?void 0:n.call(this,m)}):p()}},d=h(e,{clientId:this.clientId,context:h({},this.context)});return h(f,c(d))},{resourceName:r,resourceMethod:s}=e;return[...this.createMethodDescriptor(r,s).middleware,...this.middleware].map(t)}};var J=/{([^}?]+)\??}/,re=/\/?{([^}?]+)\?}/g,se=/\/$/,T=class o{methodDescriptor;requestParams;requestContext;constructor(e,t={},r={}){this.methodDescriptor=e,this.requestParams=t,this.requestContext=r}isParam(e){return e!==this.methodDescriptor.headersAttr&&e!==this.methodDescriptor.bodyAttr&&e!==this.methodDescriptor.authAttr&&e!==this.methodDescriptor.timeoutAttr&&e!==this.methodDescriptor.hostAttr&&e!==this.methodDescriptor.pathAttr}params(){let e=h({},this.methodDescriptor.params,this.requestParams);return Object.keys(e).reduce((t,r)=>(this.isParam(r)&&(t[r]=e[r]),t),{})}context(){return this.requestContext}method(){return this.methodDescriptor.method.toLowerCase()}host(){let{allowResourceHostOverride:e,hostAttr:t,host:r}=this.methodDescriptor,s=e?this.requestParams[t]||r||"":r||"";return typeof s=="string"?s.replace(se,""):""}path(){let{pathAttr:e,path:t}=this.methodDescriptor,r=this.requestParams[e]||t||"",s=this.params(),i;if(typeof r=="function"){if(i=r(s),typeof i!="string")throw new Error(`[Mappersmith] method descriptor function did not return a string, params=${JSON.stringify(s)}`)}else i=r;let a=new RegExp(J,"g"),c=[],f;for(;(f=a.exec(i))!==null;)c.push(f[1]);for(let n of c){let u=new RegExp(`{${n}\\??}`,"g"),l=s[n];l!=null&&typeof l!="object"&&(i=i.replace(u,this.methodDescriptor.parameterEncoder(l)),delete s[n])}i=i.replace(re,"");let d=i.match(J);if(d)throw new Error(`[Mappersmith] required parameter missing (${d[1]}), "${i}" cannot be resolved`);let p=Object.keys(s).reduce((n,u)=>{let l=this.methodDescriptor.queryParamAlias[u]||u,g=s[u];return g!=null&&(n[l]=g),n},{}),m=M(p,this.methodDescriptor.parameterEncoder);if(typeof m=="string"&&m.length!==0){let n=i.includes("?");i+=`${n?"&":"?"}${m}`}return i[0]!=="/"&&i.length>0&&(i=`/${i}`),i}pathTemplate(){let e=this.methodDescriptor.path,t=r=>r[0]!=="/"?`/${r}`:r;return t(typeof e=="function"?e(this.params()):e)}url(){return`${this.host()}${this.path()}`}headers(){let e=this.methodDescriptor.headersAttr,t=this.requestParams[e]||{};if(typeof t=="function")return t;let r={...this.methodDescriptor.headers,...t};return O(r)}header(e){let t=e.toLowerCase();if(t in this.headers())return this.headers()[t]}body(){return this.requestParams[this.methodDescriptor.bodyAttr]}auth(){return this.requestParams[this.methodDescriptor.authAttr]}timeout(){return this.requestParams[this.methodDescriptor.timeoutAttr]}enhance(e,t){let r=this.methodDescriptor.authAttr,s=this.methodDescriptor.bodyAttr,i=this.methodDescriptor.headersAttr,a=this.methodDescriptor.hostAttr,c=this.methodDescriptor.timeoutAttr,f=this.methodDescriptor.pathAttr,d=h({},this.requestParams,e.params),p=this.requestParams[i],m=h({},p,e.headers);d[i]=m,e.auth&&(d[r]=e.auth),e.body&&(d[s]=e.body),e.host&&(d[a]=e.host),e.timeout&&(d[c]=e.timeout),e.path&&(d[f]=e.path);let n={...this.requestContext,...t};return new o(this.methodDescriptor,d,n)}isBinary(){return this.methodDescriptor.binary}};var oe=o=>!(!o||!o()),v=class{Promise;manifest;GatewayClassFactory;maxMiddlewareStackExecutionAllowed;constructor(e,t,r){if(!e)throw new Error(`[Mappersmith] invalid manifest (${e})`);if(!oe(t))throw new Error("[Mappersmith] gateway class not configured (configs.gateway)");if(!r.Promise)throw new Error("[Mappersmith] Promise not configured (configs.Promise)");this.Promise=r.Promise,this.manifest=new S(e,r),this.GatewayClassFactory=t,this.maxMiddlewareStackExecutionAllowed=r.maxMiddlewareStackExecutionAllowed}build(){let e={_manifest:this.manifest};return this.manifest.eachResource((t,r)=>{e[t]=this.buildResource(t,r)}),e}buildResource(e,t){let r={};return t.reduce((i,a)=>{let c=(f,d)=>{let p=new T(a.descriptor,f,d);return this.invokeMiddlewares(String(e),a.name,p)};return{...i,[a.name]:c}},r)}invokeMiddlewares(e,t,r){let s=this.manifest.createMiddleware({resourceName:e,resourceMethod:t}),i=this.GatewayClassFactory(),a=this.manifest.gatewayConfigs,c={middleware:null,returnedInvalidRequest:!1,abortExecution:!1},f=()=>this.Promise.resolve(r),d=(u,l)=>()=>{let g=y=>{throw c.abortExecution=!0,y};return this.Promise.resolve().then(()=>l.prepareRequest(u,g)).then(y=>{if(y instanceof T)return y;c.returnedInvalidRequest=!0;let b=typeof y,_=(b==="object"||b==="function")&&y.name||b;throw new Error(`[Mappersmith] middleware "${l.__name}" should return "Request" but returned "${_}"`)}).catch(y=>{throw c.middleware=l.__name||null,y})},p=s.reduce(d,f),m=0,n=()=>p().catch(u=>{let{returnedInvalidRequest:l,abortExecution:g,middleware:y}=c;if(l||g)throw u;let b=new Error(`[Mappersmith] middleware "${y}" failed in the request phase: ${u.message}`);throw b.stack=u.stack,b}).then(u=>{if(m++,m>this.maxMiddlewareStackExecutionAllowed)throw new Error(`[Mappersmith] infinite loop detected (middleware stack invoked ${m} times). Check the use of "renew" in one of the middleware.`);let l=n,g=(_,W)=>()=>W.response(_,l,u),y=()=>new i(u,a).call();return s.reduce(g,y)()});return new this.Promise((u,l)=>{n().then(g=>u(g)).catch(l)})}};var ie=/^application\/(json|.*\+json)/,R=class o{originalRequest;responseStatus;responseData;responseHeaders;errors;timeElapsed;constructor(e,t,r,s,i){let a=e.requestParams&&e.requestParams.auth;if(a){let c={...a,password:"***"};this.originalRequest=e.enhance({auth:c})}else this.originalRequest=e;this.responseStatus=t,this.responseData=r??null,this.responseHeaders=s||{},this.errors=i||[],this.timeElapsed=null}request(){return this.originalRequest}status(){return this.responseStatus===1223?204:this.responseStatus}success(){let e=this.status();return e>=200&&e<400}headers(){return O(this.responseHeaders)}header(e){let t=e.toLowerCase();if(t in this.headers())return this.headers()[t]}rawData(){return this.responseData}data(){if(this.isContentTypeJSON()&&this.responseData!==null)try{return JSON.parse(this.responseData)}catch{}return this.responseData}isContentTypeJSON(){let e=this.header("content-type");return e===void 0?!1:ie.test(e)}error(){let e=this.errors[this.errors.length-1]||null;return typeof e=="string"?new Error(e):e}enhance(e){let t={...this.headers(),...e.headers||{}},r=new o(this.request(),e.status||this.status(),e.rawData||this.rawData(),t,e.error?[...this.errors,e.error]:[...this.errors]);return r.timeElapsed=this.timeElapsed,r}},G=R;var U="2.43.4";var w={context:{},middleware:[],Promise:typeof Promise=="function"?Promise:null,fetch:typeof fetch=="function"?fetch:null,maxMiddlewareStackExecutionAllowed:2,gateway:null,gatewayConfigs:{emulateHTTP:!1,enableHTTP408OnTimeouts:!1,XHR:{withCredentials:!1,configure:null},HTTP:{useSocketConnectionTimeout:!1,configure:null,onRequestWillStart:null,onRequestSocketAssigned:null,onSocketLookup:null,onSocketConnect:null,onSocketSecureConnect:null,onResponseReadable:null,onResponseEnd:null},Fetch:{credentials:"omit"}}},ne=o=>{console.warn("The use of setContext is deprecated - you need to find another way to pass data between your middlewares."),w.context=h(w.context,o)};function I(o){let e=()=>w.gateway;return new v(o,e,w).build()}var z=o=>o&&o.name==="TimeoutError",A=o=>{let e=new Error(o);return e.name="TimeoutError",e};var ae=/^(delete|put|patch)/i,P=class{request;configs;successCallback;failCallback;constructor(e,t){this.request=e,this.configs=t,this.successCallback=function(){},this.failCallback=function(){}}get(){throw new Error("Not implemented")}head(){throw new Error("Not implemented")}post(){throw new Error("Not implemented")}put(){throw new Error("Not implemented")}patch(){throw new Error("Not implemented")}delete(){throw new Error("Not implemented")}options(){return this.configs}shouldEmulateHTTP(){return this.options().emulateHTTP&&ae.test(this.request.method())}call(){let e=H();if(!w.Promise)throw new Error("[Mappersmith] Promise not configured (configs.Promise)");return new w.Promise((t,r)=>{this.successCallback=s=>{s.timeElapsed=H()-e,t(s)},this.failCallback=s=>{s.timeElapsed=H()-e,r(s)};try{this[this.request.method()].apply(this,arguments)}catch(s){let i=s;this.dispatchClientError(i.message,i)}})}dispatchResponse(e){e.success()?this.successCallback(e):this.failCallback(e)}dispatchClientError(e,t){z(t)&&this.options().enableHTTP408OnTimeouts?this.failCallback(new R(this.request,408,e,{},[t])):this.failCallback(new R(this.request,400,e,{},[t]))}prepareBody(e,t){let r=this.request.body();this.shouldEmulateHTTP()&&(r=r||{},D(r)&&(r._method=e),t["x-http-method-override"]=e);let s=M(r);return s&&D(r)&&(t["content-type"]="application/x-www-form-urlencoded;charset=utf-8"),s}};var L;try{L=window.btoa}catch{L=k}var N=class extends P{canceled=!1;timer;get(){let e=this.createXHR();e.open("GET",this.request.url(),!0),this.setHeaders(e,{}),this.configureTimeout(e),this.configureBinary(e),e.send()}head(){let e=this.createXHR();e.open("HEAD",this.request.url(),!0),this.setHeaders(e,{}),this.configureTimeout(e),this.configureBinary(e),e.send()}post(){this.performRequest("post")}put(){this.performRequest("put")}patch(){this.performRequest("patch")}delete(){this.performRequest("delete")}configureBinary(e){this.request.isBinary()&&(e.responseType="blob")}configureTimeout(e){this.canceled=!1,this.timer=void 0;let t=this.request.timeout();t&&(e.timeout=t,e.addEventListener("timeout",()=>{this.canceled=!0,this.timer&&clearTimeout(this.timer);let r=A(`Timeout (${t}ms)`);this.dispatchClientError(r.message,r)}),this.timer=setTimeout(()=>{this.canceled=!0;let r=A(`Timeout (${t}ms)`);this.dispatchClientError(r.message,r)},t+1))}configureCallbacks(e){e.addEventListener("load",()=>{this.canceled||(this.timer&&clearTimeout(this.timer),this.dispatchResponse(this.createResponse(e)))}),e.addEventListener("error",r=>{if(this.canceled)return;this.timer&&clearTimeout(this.timer);let s=r?r.message||r.name:e.responseText,i="Network error",a=s?`: ${s}`:"",c=new Error(`${i}${a}`);this.dispatchClientError(i,c)});let t=this.options().XHR;t.withCredentials&&(e.withCredentials=!0),t.configure&&t.configure(e)}performRequest(e){let t=this.shouldEmulateHTTP()?"post":e,r=this.createXHR();r.open(t.toUpperCase(),this.request.url(),!0);let s={},i=this.prepareBody(e,s);this.setHeaders(r,s),this.configureTimeout(r),this.configureBinary(r),r.send(i)}createResponse(e){let t=e.status,r=this.request.isBinary()?e.response:e.responseText,s=K(e.getAllResponseHeaders());return new G(this.request,t,r,s)}setHeaders(e,t){let r=this.request.auth(),s=h(t,{...this.request.headers(),...r?{authorization:`Basic ${L(`${r.username}:${r.password}`)}`}:{}});Object.keys(s).forEach(i=>{e.setRequestHeader(i,`${s[i]}`)})}createXHR(){let e=new XMLHttpRequest;return this.configureCallbacks(e),e}};var j=class extends P{get(){this.performRequest("get")}head(){this.performRequest("head")}post(){this.performRequest("post")}put(){this.performRequest("put")}patch(){this.performRequest("patch")}delete(){this.performRequest("delete")}performRequest(e){let t=w.fetch;if(!t)throw new Error('[Mappersmith] global fetch does not exist, please assign "configs.fetch" to a valid implementation');let r={},s=this.prepareBody(e,r),i=this.request.auth();if(i){let n=i.username||"",u=i.password||"";r.authorization=`Basic ${k(`${n}:${u}`)}`}let a=h(r,this.request.headers()),c=this.shouldEmulateHTTP()?"post":e,f=h({method:c,headers:a,body:s},this.options().Fetch),d=this.request.timeout(),p=null,m=!1;d&&(p=setTimeout(()=>{m=!0;let n=A(`Timeout (${d}ms)`);this.dispatchClientError(n.message,n)},d)),t(this.request.url(),f).then(n=>{if(m)return;p&&clearTimeout(p);let u;this.request.isBinary()?typeof n.buffer=="function"?u=n.buffer():u=n.arrayBuffer():u=n.text(),u.then(l=>{this.dispatchResponse(this.createResponse(n,l))})}).catch(n=>{m||(p&&clearTimeout(p),this.dispatchClientError(n.message,n))})}createResponse(e,t){let r=e.status,s={};return e.headers.forEach((i,a)=>{s[a]=i}),new G(this.request,r,t,s)}};var Q=null,$=null;try{Q=eval('typeof __TEST_SERVICE_WORKER__ === "undefined" && typeof process === "object" ? process : undefined')}catch(o){}typeof XMLHttpRequest<"u"?$=N:typeof Q<"u"?$=void 0:typeof self<"u"&&($=j);w.gateway=$;export{R as Response,w as configs,I as default,I as forge,ne as setContext,U as version};
//# sourceMappingURL=mappersmith.production.min.mjs.map